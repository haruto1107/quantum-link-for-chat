<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>quantum-link for chat - プロフィール設定</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:system-ui, -apple-system, "Yu Gothic", sans-serif;padding:20px}
.box{max-width:480px;margin:0 auto}
input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button{padding:10px;border-radius:8px;border:none;background:#007bff;color:#fff;cursor:pointer}
#avatarPreview{width:96px;height:96px;border-radius:50%;background:#eee;overflow:hidden;margin-bottom:8px}
</style>
</head>
<body>
<div class="box">
<h2>プロフィールを設定してください</h2>
<div id="avatarPreview"></div>
<input id="nameInput" placeholder="表示名（例：晴翔）" />
<input id="avatarFile" type="file" accept="image/*" />
<div style="margin-top:12px">
<button id="saveBtn">保存してチャットへ</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
apiKey: "AIzaSyA7hliguaqhkVXufJPP2X3u0ekIdK4XbWU",
authDomain: "quantum-link-for-chat.firebaseapp.com",
projectId: "quantum-link-for-chat",
storageBucket: "quantum-link-for-chat.firebasestorage.app",
messagingSenderId: "222382991426",
appId: "1:222382991426:web:43326da4ed94d7fb37a5db",
measurementId: "G-1YVZ7HWJJT"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const nameInput = document.getElementById('nameInput');
const avatarFile = document.getElementById('avatarFile');
const avatarPreview = document.getElementById('avatarPreview');
const saveBtn = document.getElementById('saveBtn');

let currentUser = null;
onAuthStateChanged(auth, (user) => {
if (!user) {
location.href = "login.html";
return;
}
currentUser = user;
if (user.displayName) nameInput.value = user.displayName;
if (user.photoURL) avatarPreview.innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;object-fit:cover">`;
});

avatarFile.addEventListener('change', (ev) => {
const f = ev.target.files[0];
if (!f) return;
const url = URL.createObjectURL(f);
avatarPreview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
});

saveBtn.addEventListener('click', async () => {
if (!currentUser) return alert("ログインしてください");
const name = nameInput.value.trim();
if (!name) return alert("表示名を入力してください");
let photoURL = currentUser.photoURL || "";

// もしファイル選択があれば Storage にアップロード
const file = avatarFile.files[0];
if (file) {
const path = `avatars/${currentUser.uid}/${Date.now()}_${file.name}`;
const ref = sRef(storage, path);
const task = uploadBytesResumable(ref, file);
await new Promise((resolve, reject) => {
task.on('state_changed', null, (err) => reject(err), () => resolve());
});
photoURL = await getDownloadURL(task.snapshot.ref);
}

// Auth の displayName / photoURL 更新
await updateProfile(currentUser, { displayName: name, photoURL: photoURL });

// Firestore の users ドキュメント更新
await setDoc(doc(db, "users", currentUser.uid), {
uid: currentUser.uid,
name: name,
photoURL: photoURL,
email: currentUser.email || null,
updatedAt: serverTimestamp()
}, { merge: true });

alert("プロフィールを保存しました。チャット画面へ移動します。");
location.href = "chat.html";
});
</script>
</body>
</html>
