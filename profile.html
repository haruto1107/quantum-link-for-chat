<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>quantum-link for chat - プロフィール</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui;padding:20px}
    .box{max-width:420px;margin:auto}
    input,button{width:100%;padding:12px;margin-top:12px}
    button{background:#06c755;color:#fff;border:none;border-radius:8px}
  </style>
</head>
<body>
<div class="box">
  <h2>プロフィール設定</h2>
  <input id="nameInput" placeholder="表示名（例：晴翔）">
  <button id="saveBtn" type="button">保存してチャットへ</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA7hliguaqhkVXufJPP2X3u0ekIdK4XbWU",
    authDomain: "quantum-link-for-chat.firebaseapp.com",
    projectId: "quantum-link-for-chat",
    storageBucket: "quantum-link-for-chat.firebasestorage.app",
    messagingSenderId: "222382991426",
    appId: "1:222382991426:web:43326da4ed94d7fb37a5db"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const nameInput = document.getElementById("nameInput");
  const saveBtn = document.getElementById("saveBtn");

  let user = null;

  onAuthStateChanged(auth, u => {
    if (!u) location.href = "login.html";
    user = u;
  });

  saveBtn.onclick = async () => {
    const name = nameInput.value.trim();
    if (!name) {
      alert("名前を入力してください");
      return;
    }

    await updateProfile(user, { displayName: name });

    await setDoc(doc(db, "users", user.uid), {
      uid: user.uid,
      name: name,
      createdAt: serverTimestamp()
    });

    location.href = "chat.html";
  };
</script>
</body>
</html>
