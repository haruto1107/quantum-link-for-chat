<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>quantum-link for chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Yu Gothic", sans-serif;
      background: #f2f2f7;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #header {
      background: #007AFF;
      color: white;
      padding: 12px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }
    #chatArea {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .msg {
      max-width: 70%;
      padding: 10px 14px;
      margin-bottom: 10px;
      border-radius: 12px;
      background: white;
      display: inline-block;
      position: relative;
    }
    .mine {
      background: #007AFF;
      color: white;
      margin-left: auto;
    }
    .info {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 2px;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
    }
    #msg {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #sendBtn {
      padding: 10px 16px;
      margin-left: 8px;
      background: #007AFF;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="header">quantum-link for chat</div>
  <div id="chatArea"></div>

  <div id="inputArea">
    <input id="msg" placeholder="メッセージ…" />
    <button id="sendBtn">送信</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      orderBy,
      query,
      serverTimestamp,
      doc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7hliguaqhkVXufJPP2X3u0ekIdK4XbWU",
      authDomain: "quantum-link-for-chat.firebaseapp.com",
      projectId: "quantum-link-for-chat",
      storageBucket: "quantum-link-for-chat.firebasestorage.app",
      messagingSenderId: "222382991426",
      appId: "1:222382991426:web:43326da4ed94d7fb37a5db",
      measurementId: "G-1YVZ7HWJJT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let roomId = "globalChat"; // ★ 今は全員が１つの部屋で話す

    onAuthStateChanged(auth, async (user) => {
      if (!user) location.href = "login.html";
      currentUser = user;

      // 既読管理のため、ユーザー情報を rooms に登録
      await setDoc(doc(db, "rooms", roomId, "members", user.uid), {
        uid: user.uid,
        name: user.displayName || "NoName",
        lastRead: serverTimestamp()
      }, { merge: true });

      loadMessages();
    });

    // メッセージ送信
    async function sendMessage() {
      const text = document.getElementById("msg").value;
      if (!text.trim()) return;
      document.getElementById("msg").value = "";

      await addDoc(collection(db, "rooms", roomId, "messages"), {
        text: text,
        uid: currentUser.uid,
        name: currentUser.displayName || "NoName",
        time: serverTimestamp()
      });

      // 自分の既読更新
      await updateDoc(doc(db, "rooms", roomId, "members", currentUser.uid), {
        lastRead: serverTimestamp()
      });
    }

    document.getElementById("sendBtn").onclick = sendMessage;

    // メッセージ読み込み
    function loadMessages() {
      const q = query(
        collection(db, "rooms", roomId, "messages"),
        orderBy("time", "asc")
      );

      onSnapshot(q, (snap) => {
        const area = document.getElementById("chatArea");
        area.innerHTML = "";

        snap.forEach((doc) => {
          const d = doc.data();
          const div = document.createElement("div");

          div.classList.add("msg");
          if (d.uid === currentUser.uid) div.classList.add("mine");

          const time = d.time?.toDate
            ? d.time.toDate().toLocaleTimeString()
            : "";

          div.innerHTML = `
            <div>${d.text}</div>
            <div class="info">${d.name}・${time}</div>
          `;

          area.appendChild(div);
        });

        area.scrollTop = area.scrollHeight;
      });
    }
  </script>
</body>
</html>
