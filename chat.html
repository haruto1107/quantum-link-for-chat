<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>quantum-link for chat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="navbar">quantum-link for chat</div>

<div class="page">

  <select id="roomSelect" class="input">
    <option value="public">ğŸŒ Public Chat</option>
  </select>

  <div id="chatArea" class="chat-list"></div>

  <div style="display:flex;gap:8px;margin-top:12px">
    <input id="msg" class="input" style="flex:1" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
    <button id="send" class="btn btn-primary">é€ä¿¡</button>
  </div>

</div>

<script type="module">

  import { app } from "./firebase.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot,
    updateDoc, doc, serverTimestamp, setDoc, getDocs
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  import {
    getAuth, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  let currentRoom = "public";

  // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }
    currentUser = user;

    // 1å¯¾1ãƒãƒ£ãƒƒãƒˆç”¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
    const users = await getDocs(collection(db, "users"));
    users.forEach(u => {
      if (u.id !== user.uid) {
        roomSelect.innerHTML += `<option value="dm_${user.uid}_${u.id}">${u.data().name} ã¨ãƒãƒ£ãƒƒãƒˆ</option>`;
      }
    });

    loadRoom(currentRoom);
  });

  // éƒ¨å±‹å¤‰æ›´
  roomSelect.onchange = () => {
    currentRoom = roomSelect.value;
    loadRoom(currentRoom);
  };

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  send.onclick = async () => {
    const text = msg.value.trim();
    if (!text) return;

    await addDoc(collection(db, "rooms", currentRoom, "messages"), {
      uid: currentUser.uid,
      text,
      time: serverTimestamp(),
      read: false
    });

    msg.value = "";
  };

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
  function loadRoom(room) {
    const q = query(
      collection(db, "rooms", room, "messages"),
      orderBy("time")
    );

    onSnapshot(q, async (snap) => {
      chatArea.innerHTML = "";

      for (const m of snap.docs) {
        const d = m.data();
        const mine = d.uid === currentUser.uid;
        const div = document.createElement("div");
        div.className = "msg " + (mine ? "my" : "other");
        div.innerHTML = d.text;

        // æ—¢èª­
        if (!mine && !d.read) {
          await updateDoc(doc(db, "rooms", room, "messages", m.id), {
            read: true
          });
        }

        chatArea.appendChild(div);

        // é€ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¢èª­è¡¨ç¤º
        if (mine) {
          const rd = document.createElement("div");
          rd.className = "read";
          rd.textContent = d.read ? "æ—¢èª­" : "æœªèª­";
          chatArea.appendChild(rd);
        }
      }

      chatArea.scrollTop = chatArea.scrollHeight;
    });
  }

</script>

</body>
</html>
