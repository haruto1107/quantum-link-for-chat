<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>quantum-link for chat</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }

    /* Â∑¶ÂÅ¥Ôºö„É´„Éº„É†‰∏ÄË¶ß */
    #sidebar {
      width: 280px;
      background: #f2f2f2;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
    }

    .room {
      padding: 10px;
      background: #fff;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
    }

    .room:hover {
      background: #e8e8e8;
    }

    /* Âè≥ÂÅ¥Ôºö„ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢ */
    #chatArea {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    #chatHeader {
      padding: 15px;
      border-bottom: 1px solid #ddd;
      font-size: 20px;
      background: #fff;
    }

    #chat {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fafafa;
    }

    .msg {
      padding: 8px 12px;
      border-radius: 12px;
      margin-bottom: 12px;
      max-width: 70%;
      position: relative;
      font-size: 15px;
    }

    .me {
      background: #d1ffd6;
      margin-left: auto;
    }

    .other {
      background: #ffffff;
      border: 1px solid #ddd;
    }

    .icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .msgWrap {
      display: flex;
      align-items: flex-end;
      margin-bottom: 10px;
    }

    .otherWrap {
      flex-direction: row;
    }

    .meWrap {
      flex-direction: row-reverse;
    }

    .read {
      font-size: 11px;
      color: #666;
      margin-top: 3px;
      text-align: right;
    }

    #inputArea {
      display: flex;
      padding: 12px;
      border-top: 1px solid #ddd;
      background: #fff;
    }

    #msg {
      flex-grow: 1;
      padding: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      padding: 10px 18px;
      margin-left: 8px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- „É´„Éº„É†‰∏ÄË¶ß -->
  <div id="sidebar">
    <h2>Chats</h2>
    <div id="roomList"></div>
  </div>

  <!-- „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢ -->
  <div id="chatArea">
    <div id="chatHeader">Select a chat</div>
    <div id="chat"></div>

    <div id="inputArea">
      <input id="msg" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ‚Ä¶" />
      <button id="sendBtn">ÈÄÅ‰ø°</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc,
      onSnapshot, doc, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA7hliguaqhkVXufJPP2X3u0ekIdK4XbWU",
      authDomain: "quantum-link-for-chat.firebaseapp.com",
      projectId: "quantum-link-for-chat",
      storageBucket: "quantum-link-for-chat.firebasestorage.app",
      messagingSenderId: "222382991426",
      appId: "1:222382991426:web:43326da4ed94d7fb37a5db",
      measurementId: "G-1YVZ7HWJJT",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let currentUser = null;
    let currentRoom = null;

    // Ë™çË®º
    onAuthStateChanged(auth, (user) => {
      if (!user) location.href = "login.html";
      currentUser = user;
      loadRooms();
    });

    // üî• „É´„Éº„É†Ë™≠„ÅøËæº„Åø
    function loadRooms() {
      onSnapshot(collection(db, "rooms"), (snap) => {
        const list = document.getElementById("roomList");
        list.innerHTML = "";
        snap.forEach((r) => {
          const data = r.data();
          const div = document.createElement("div");
          div.className = "room";
          div.textContent = data.name;
          div.onclick = () => openRoom(r.id, data.name);
          list.appendChild(div);
        });
      });
    }

    // üî• „É´„Éº„É†„ÇíÈñã„Åè
    function openRoom(roomId, name) {
      currentRoom = roomId;
      document.getElementById("chatHeader").textContent = name;
      loadMessages(roomId);
    }

    // üî• „É°„ÉÉ„Çª„Éº„Ç∏Ë™≠„ÅøËæº„Åø
    function loadMessages(roomId) {
      const q = query(
        collection(db, "rooms", roomId, "messages"),
        orderBy("time")
      );

      onSnapshot(q, (snap) => {
        const area = document.getElementById("chat");
        area.innerHTML = "";

        snap.forEach(async (d) => {
          const msg = d.data();
          const wrap = document.createElement("div");
          wrap.className = "msgWrap " + (msg.uid === currentUser.uid ? "meWrap" : "otherWrap");

          const bubble = document.createElement("div");
          bubble.className = "msg " + (msg.uid === currentUser.uid ? "me" : "other");
          bubble.textContent = msg.text;

          const read = document.createElement("div");
          read.className = "read";

          // Êó¢Ë™≠‰∫∫Êï∞
          if (msg.uid === currentUser.uid) {
            const count = msg.readBy ? msg.readBy.length - 1 : 0;
            read.textContent = count > 0 ? `Êó¢Ë™≠ ${count}` : "Êú™Ë™≠";
          }

          bubble.appendChild(read);

          wrap.appendChild(bubble);
          area.appendChild(wrap);

          // Ëá™ÂàÜ‰ª•Â§ñ ‚Üí Êó¢Ë™≠„Å§„Åë„Çã
          if (msg.uid !== currentUser.uid) {
            const arr = msg.readBy ?? [];
            if (!arr.includes(currentUser.uid)) {
              await updateDoc(doc(db, "rooms", roomId, "messages", d.id), {
                readBy: [...arr, currentUser.uid]
              });
            }
          }
        });

        area.scrollTop = area.scrollHeight;
      });
    }

    // üî• „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
    document.getElementById("sendBtn").onclick = async () => {
      const text = document.getElementById("msg").value;
      if (!text || !currentRoom) return;

      await addDoc(collection(db, "rooms", currentRoom, "messages"), {
        text,
        uid: currentUser.uid,
        img: currentUser.photoURL ?? "",
        readBy: [],
        time: serverTimestamp()
      });

      document.getElementById("msg").value = "";
    };
  </script>
</body>
</html>
